<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Non-Negotiable Tasks — Stacked Actions</title>
<style>
  :root{
    --bg:#f7f7f8;
    --panel:#ffffff;
    --muted:#6b6f73;
    --accent:#4c5055;
    --success:#2d9f6a;
    --danger:#e25353;
    --glass: rgba(76,80,85,0.06);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#111;padding:12px;box-sizing:border-box}
  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
  .header-left{display:flex;align-items:center;gap:10px;min-width:0}
  .hamburger{width:44px;height:44px;border-radius:10px;border:0;background:var(--panel);box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:center}
  .hamburger:focus{outline:2px solid rgba(76,80,85,0.14)}
  .title-wrap{flex:1;display:flex;flex-direction:column;align-items:center;min-width:0}
  h1{font-size:18px;margin:0;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .date-row{font-size:12px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  button.btn{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:10px;font-weight:700;min-width:42px}
  button.ghost{background:transparent;color:var(--accent);border:1px solid var(--glass)}
  /* Drawer */
  .drawer-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.35);z-index:80}
  .drawer{position:fixed;left:0;top:0;bottom:0;width:300px;background:var(--panel);box-shadow:8px 0 30px rgba(0,0,0,0.12);transform:translateX(-110%);transition:transform .22s ease;z-index:90;padding:14px;display:flex;flex-direction:column;gap:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .section{display:flex;flex-direction:column;gap:8px}
  .drawer .close{align-self:flex-end;padding:6px;border-radius:8px;border:0;background:transparent}
  /* main */
  main{display:flex;flex-direction:column;gap:12px;}
  .summary{background:linear-gradient(180deg,#fff,#fbfbfb);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;justify-content:space-between;align-items:center}
  .left{display:flex;flex-direction:column;}
  .big{font-size:16px;font-weight:700;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .task-list{display:flex;flex-direction:column;gap:10px;margin-bottom:88px}
  /* slimmer task card + stacked buttons */
  .task-card{background:var(--panel);padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;flex-direction:row;gap:12px;align-items:flex-start;position:relative}
  .task-left{flex:1;display:flex;flex-direction:column;gap:6px;padding-right:12px}
  .task-title{font-weight:700;color:#111;font-size:18px}
  .task-meta{font-size:12px;color:var(--muted)}
  .task-right{display:flex;flex-direction:column;align-items:center;gap:8px;min-width:44px}
  .stack-btn{width:44px;height:44px;border-radius:12px;border:0;background:var(--panel);box-shadow:0 6px 18px rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700}
  .stack-btn[aria-label="Start"]{background:linear-gradient(90deg,var(--accent),#2f3336);color:#fff}
  .stack-btn[aria-label="End"]{background:var(--danger);color:#fff}
  .stack-btn[aria-label="Delete"]{background:#fff;border:1px solid var(--glass);color:var(--muted)}
  .stack-btn:disabled{opacity:0.45;cursor:not-allowed;box-shadow:none}
  .progress{height:8px;background:var(--glass);border-radius:6px;overflow:hidden;margin-top:6px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#6b6f73);width:0%}
  .fab{position:fixed;right:16px;bottom:18px;z-index:30}
  .fab button{width:56px;height:56px;border-radius:999px;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(76,80,85,0.14)}
  .inputs{display:flex;gap:8px}
  input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass);font-size:15px}
  @media(min-width:720px){ body{max-width:880px;margin:12px auto} .hamburger{display:none} .title-wrap{align-items:flex-start} .controls{display:flex} .drawer-backdrop{display:none} }
  /* small utilities */
  .muted{color:var(--muted);font-size:12px}
  .tiny{font-size:11px;color:var(--muted)}
  .running-dot{width:10px;height:10px;border-radius:20px;background:var(--success);display:inline-block;margin-right:6px;box-shadow:0 4px 10px rgba(45,159,106,0.2)}
  footer.smallprint{position:fixed;left:12px;bottom:10px;font-size:12px;color:var(--muted)}
  .user-badge{background:var(--glass);padding:6px 8px;border-radius:999px;color:var(--accent);font-weight:700}
  .drawer .nav-btn{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:0;background:var(--bg);font-weight:700}
  /* Hide inline nav on small screens (ensure header is compact) */
  @media (max-width: 720px) {
    #controls-inline button { display: none !important; }
  }
</style>
</head>
<body>
<header>
  <div class="header-left">
    <button class="hamburger" id="hamburger" aria-label="Open menu" title="Menu">
      <svg width="20" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect y="0" width="20" height="2" rx="1" fill="#4c5055"/>
        <rect y="6" width="20" height="2" rx="1" fill="#4c5055"/>
        <rect y="12" width="20" height="2" rx="1" fill="#4c5055"/>
      </svg>
    </button>
    <div class="title-wrap">
      <h1>Daily Non-Negotiable Tasks</h1>
      <div class="date-row" id="date-display">Loading date…</div>
    </div>
  </div>

  <div class="controls" id="controls-inline">
    <!-- Navigation buttons are hidden on small screens (moved to drawer) -->
    <button class="btn ghost" id="prev-day" title="Previous day">‹</button>
    <button class="btn" id="today" title="Jump to today">Today</button>
    <button class="btn ghost" id="next-day" title="Next day">›</button>
    <!-- Header intentionally does not show user email/badge -->
    <div id="user-area"></div>
  </div>
</header>

<!-- Drawer overlay + menu -->
<div class="drawer-backdrop" id="drawer-backdrop" aria-hidden="true">
  <nav class="drawer" id="drawer" aria-label="Main menu">
    <button class="close" id="drawer-close" aria-label="Close menu">✕</button>

    <div class="section">
      <button class="nav-btn" id="drawer-prev">‹ Previous</button>
      <button class="nav-btn" id="drawer-today">Today</button>
      <button class="nav-btn" id="drawer-next">Next ›</button>
    </div>

    <div class="section">
      <button class="nav-btn" id="drawer-export">Export CSV</button>
      <button class="nav-btn" id="drawer-clear">Clear Day</button>
    </div>

    <div class="section" id="drawer-auth-area">
      <!-- auth buttons or user badge inserted here by JS -->
    </div>

    <div style="margin-top:auto;font-size:12px;color:var(--muted)">Stored locally (or in Firebase when signed in)</div>
  </nav>
</div>

<main>
  <!-- Slimmed summary: no Export/Clear in the card -->
  <div class="summary" aria-live="polite">
    <div class="left">
      <div class="big" id="total-time">Total: 00:00:00</div>
      <div class="small" id="total-percent">0.00% of 24 hours</div>
    </div>
  </div>

  <div class="inputs">
    <input id="new-task-name" type="text" placeholder="Add a new task (e.g., 'Morning routine')" aria-label="New task name"/>
    <button class="btn" id="add-task">Add</button>
  </div>

  <section class="task-list" id="task-list" aria-live="polite">
    <!-- tasks -->
  </section>
</main>

<div class="fab" title="Add task quick">
  <button id="fab-add">+</button>
</div>

<footer class="smallprint">Saved locally (localStorage). Works offline.</footer>

<!-- Firebase + app logic -->
<script type="module">
/* ========= Firebase configuration (replaceable) ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBIwCmbfK4949rj4RKLTihhLtsvQzjwU-w",
  authDomain: "dailytasks-64e5a.firebaseapp.com",
  projectId: "dailytasks-64e5a",
  storageBucket: "dailytasks-64e5a.firebasestorage.app",
  messagingSenderId: "905259758762",
  appId: "1:905259758762:web:2da8fe74302022c39e4cd3",
  measurementId: "G-FKXHY4E8V5"
};

/* Firebase modular imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI refs */
const hamburger = document.getElementById('hamburger');
const drawerBackdrop = document.getElementById('drawer-backdrop');
const drawer = document.getElementById('drawer');
const drawerClose = document.getElementById('drawer-close');
const drawerPrev = document.getElementById('drawer-prev');
const drawerToday = document.getElementById('drawer-today');
const drawerNext = document.getElementById('drawer-next');
const drawerExport = document.getElementById('drawer-export');
const drawerClear = document.getElementById('drawer-clear');
const drawerAuthArea = document.getElementById('drawer-auth-area');

const dateDisplay = document.getElementById('date-display');
const taskListEl = document.getElementById('task-list');
const totalTimeEl = document.getElementById('total-time');
const totalPercentEl = document.getElementById('total-percent');
const newTaskInput = document.getElementById('new-task-name');
const addTaskBtn = document.getElementById('add-task');
const fabAdd = document.getElementById('fab-add');
const prevBtn = document.getElementById('prev-day');
const nextBtn = document.getElementById('next-day');
const todayBtn = document.getElementById('today');
const controlsInline = document.getElementById('controls-inline');
const userArea = document.getElementById('user-area');

let currentDate = new Date();
let data = { date: isoDate(currentDate), tasks: [] };
let liveTimerInterval = null;
let currentUser = null;

/* utilities */
function isoDate(d){
  const t = new Date(d);
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,10);
}
function nowISO(){ return new Date().toISOString(); }
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,10); }
function secondsToHHMMSS(sec){
  sec = Math.max(0, Math.round(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return [h,m,s].map(n=>String(n).padStart(2,'0')).join(':');
}
function percentOfDaySeconds(sec){ return (sec/(24*3600))*100; }

/* local cache */
const LOCAL_PREFIX = 'dnt_tasks:';
function localKeyForDate(dateIso){
  const userPart = currentUser ? `${currentUser.uid}:` : 'guest:';
  return LOCAL_PREFIX + userPart + dateIso;
}
function readLocal(dateIso){
  const raw = localStorage.getItem(localKeyForDate(dateIso));
  if(!raw) return { date: dateIso, tasks: [] };
  try { return JSON.parse(raw); } catch(e) { return { date: dateIso, tasks: [] }; }
}
function writeLocal(obj){
  localStorage.setItem(localKeyForDate(obj.date), JSON.stringify(obj));
}

/* Firestore */
function dayDocRef(uid, dateIso){ return doc(db, 'users', uid, 'days', dateIso); }
async function readRemoteDay(uid, dateIso){
  try{
    const snap = await getDoc(dayDocRef(uid, dateIso));
    if(snap.exists()) return snap.data();
    return null;
  }catch(err){ console.warn('Firestore read error', err); return null; }
}
async function writeRemoteDay(uid, dayObj){
  try{ await setDoc(dayDocRef(uid, dayObj.date), dayObj); return true; }catch(err){ console.warn('Firestore write error', err); return false; }
}

/* data math */
function durationSecondsForSessions(sessions, dayIso = null){
  let total = 0;
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : new Date();
    if(!start) continue;
    if(dayIso){
      const dayStart = new Date(dayIso + 'T00:00:00');
      const dayEnd = new Date(dayIso + 'T23:59:59.999');
      const segStart = start > dayStart ? start : dayStart;
      const segEnd = end < dayEnd ? end : dayEnd;
      if(segEnd > segStart) total += (segEnd - segStart) / 1000;
    } else {
      if(end > start) total += (end - start) / 1000;
    }
  }
  return Math.max(0, total);
}

/* Render auth controls (drawer only) */
function renderAuthControls(){
  drawerAuthArea.innerHTML = '';
  Array.from(controlsInline.querySelectorAll('.auth-btn')).forEach(n => n.remove());
  userArea.innerHTML = '';
  if(currentUser){
    const drawerBadge = document.createElement('div');
    drawerBadge.className = 'user-badge';
    drawerBadge.innerText = currentUser.email || currentUser.uid;
    const drawerLogout = document.createElement('button');
    drawerLogout.className = 'btn ghost';
    drawerLogout.innerText = 'Logout';
    drawerLogout.addEventListener('click', async () => { await signOut(auth); });
    drawerAuthArea.appendChild(drawerBadge);
    drawerAuthArea.appendChild(drawerLogout);
  } else {
    const drawerLogin = document.createElement('button');
    drawerLogin.className = 'btn auth-btn';
    drawerLogin.innerText = 'Login';
    drawerLogin.addEventListener('click', () => openAuthModal('login'));
    const drawerReg = document.createElement('button');
    drawerReg.className = 'btn ghost auth-btn';
    drawerReg.innerText = 'Register';
    drawerReg.addEventListener('click', () => openAuthModal('register'));
    drawerAuthArea.appendChild(drawerLogin);
    drawerAuthArea.appendChild(drawerReg);
  }
}

/* Auth modal builder & actions */
function openAuthModal(mode='login'){
  const backdrop = document.createElement('div');
  backdrop.style.position = 'fixed';
  backdrop.style.inset = '0';
  backdrop.style.background = 'rgba(0,0,0,0.35)';
  backdrop.style.zIndex = '120';
  const modal = document.createElement('div');
  modal.style.background = '#fff';
  modal.style.padding = '16px';
  modal.style.borderRadius = '10px';
  modal.style.width = '92%';
  modal.style.maxWidth = '420px';
  modal.style.margin = '8% auto';
  modal.setAttribute('role','dialog');

  if(mode === 'register'){
    modal.innerHTML = `
      <h3>Create account</h3>
      <div style="margin-top:8px">
        <input id="m-email" type="email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/>
        <div style="height:8px"></div>
        <input id="m-pass" type="password" placeholder="Password (min 6)" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="m-create" class="btn">Create</button>
        <button id="m-cancel" class="btn ghost">Cancel</button>
      </div>
    `;
    backdrop.addEventListener('click', closeModal);
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);

    document.getElementById('m-cancel').addEventListener('click', closeModal);
    document.getElementById('m-create').addEventListener('click', async () => {
      const e = document.getElementById('m-email').value.trim();
      const p = document.getElementById('m-pass').value;
      if(!e || !p || p.length < 6){ alert('Provide email and password (min 6).'); return; }
      try{
        await createUserWithEmailAndPassword(auth, e, p);
        closeModal();
      }catch(err){ alert('Register error: ' + (err.message || err)); }
    });

  } else {
    modal.innerHTML = `
      <h3>Login</h3>
      <div style="margin-top:8px">
        <input id="m-email" type="email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/>
        <div style="height:8px"></div>
        <input id="m-pass" type="password" placeholder="Password" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="m-login" class="btn">Login</button>
        <button id="m-cancel" class="btn ghost">Cancel</button>
      </div>
    `;
    backdrop.addEventListener('click', closeModal);
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);

    document.getElementById('m-cancel').addEventListener('click', closeModal);
    document.getElementById('m-login').addEventListener('click', async () => {
      const e = document.getElementById('m-email').value.trim();
      const p = document.getElementById('m-pass').value;
      if(!e || !p){ alert('Provide email & password.'); return; }
      try{
        await signInWithEmailAndPassword(auth, e, p);
        closeModal();
      }catch(err){ alert('Login error: ' + (err.message || err)); }
    });
  }

  function closeModal(){
    if(modal.parentNode) modal.remove();
    if(backdrop.parentNode) backdrop.remove();
  }
}

/* Rendering tasks with stacked buttons */
function render(){
  const iso = isoDate(currentDate);
  taskListEl.innerHTML = '';
  data.tasks = data.tasks || [];
  data.tasks.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
  for(const t of data.tasks){
    const card = document.createElement('article');
    card.className = 'task-card';
    card.dataset.id = t.id;

    const left = document.createElement('div'); left.className = 'task-left';
    const titleRow = document.createElement('div'); titleRow.style.display='flex'; titleRow.style.alignItems='center'; titleRow.style.gap='8px';
    const running = hasRunningSession(t);
    if(running){
      const dot = document.createElement('span'); dot.className = 'running-dot'; titleRow.appendChild(dot);
    }
    const titleText = document.createElement('div'); titleText.contentEditable = true; titleText.spellcheck = false; titleText.innerText = t.name || 'Untitled task';
    titleText.style.outline = 'none';
    titleText.style.fontWeight = '700';
    titleText.style.fontSize = '18px';
    titleText.addEventListener('blur', ()=> { t.name = titleText.innerText.trim() || 'Untitled task'; saveData(); });
    titleText.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter'){ ev.preventDefault(); titleText.blur(); }});
    titleRow.appendChild(titleText);
    left.appendChild(titleRow);

    const meta = document.createElement('div'); meta.className = 'task-meta';
    const dur = durationSecondsForSessions(t.sessions || [], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    left.appendChild(meta);

    const progressWrap = document.createElement('div'); progressWrap.className = 'progress'; const progressInner = document.createElement('i');
    progressInner.style.width = Math.min(100, percentOfDaySeconds(dur)) + '%';
    progressWrap.appendChild(progressInner);
    left.appendChild(progressWrap);

    /* Right: stacked buttons (Start / End / Delete) */
    const right = document.createElement('div'); right.className = 'task-right';

    const btnStart = document.createElement('button');
    btnStart.className = 'stack-btn';
    btnStart.setAttribute('aria-label','Start');
    btnStart.title = 'Start';
    btnStart.innerText = '⏵';
    btnStart.addEventListener('click', async (e) => { e.stopPropagation(); if(hasRunningSession(t)){ alert('Task already running'); return; } await startSession(t); });

    const btnEnd = document.createElement('button');
    btnEnd.className = 'stack-btn';
    btnEnd.setAttribute('aria-label','End');
    btnEnd.title = 'End';
    btnEnd.innerText = '■';
    btnEnd.addEventListener('click', async (e) => { e.stopPropagation(); if(!hasRunningSession(t)){ alert('No running session to end'); return; } await endSession(t); });

    const btnDelete = document.createElement('button');
    btnDelete.className = 'stack-btn';
    btnDelete.setAttribute('aria-label','Delete');
    btnDelete.title = 'Delete';
    btnDelete.innerText = '✕';
    btnDelete.addEventListener('click', async (e) => { e.stopPropagation(); if(confirm('Delete this task and its sessions?')){ data.tasks = data.tasks.filter(x=>x.id !== t.id); await saveData(); render(); } });

    // disable/enable according to running state
    if(hasRunningSession(t)){
      btnStart.disabled = true;
      btnEnd.disabled = false;
    } else {
      btnStart.disabled = false;
      btnEnd.disabled = true;
    }

    right.appendChild(btnStart);
    right.appendChild(btnEnd);
    right.appendChild(btnDelete);

    card.appendChild(left);
    card.appendChild(right);
    taskListEl.appendChild(card);
  }

  const totalSec = (data.tasks || []).reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions || [], iso), 0);
  totalTimeEl.textContent = 'Total: ' + secondsToHHMMSS(totalSec);
  totalPercentEl.textContent = percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}

/* session helpers */
function lastSessionTimesText(task, dayIso){
  const iso = dayIso || isoDate(currentDate);
  const sessions = (task.sessions || []).slice().reverse();
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : (s.start ? new Date() : null);
    if(!start) continue;
    const dayStart = new Date(iso + 'T00:00:00');
    const dayEnd = new Date(iso + 'T23:59:59.999');
    const segStart = start > dayStart ? start : dayStart;
    const segEnd = end < dayEnd ? end : dayEnd;
    if(segEnd > segStart){
      return `Start: ${segStart.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} • End: ${s.end ? segEnd.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '—'}`;
    }
  }
  return 'Start: — • End: —';
}
function hasRunningSession(task){ return (task.sessions||[]).some(s => s.start && !s.end); }

async function startSession(task){
  if(hasRunningSession(task)){ alert('This task already has a running session. End it first.'); return; }
  const s = { start: nowISO(), end: null };
  task.sessions = task.sessions || [];
  task.sessions.push(s);
  await saveData();
  render();
}

async function endSession(task){
  const sessions = task.sessions || [];
  const idx = sessions.map(s=>s.start && !s.end ? 1:0).lastIndexOf(1);
  if(idx === -1){ alert('No running session found for this task. Press Start first.'); return; }
  const s = sessions[idx];
  const endTime = new Date();
  const startTime = new Date(s.start);
  if(startTime.toDateString() !== endTime.toDateString()){
    const endOfStartDay = new Date(startTime); endOfStartDay.setHours(23,59,59,999); s.end = endOfStartDay.toISOString();
    let nextStart = new Date(startTime); nextStart.setDate(nextStart.getDate() + 1); nextStart.setHours(0,0,0,0);
    if(nextStart.toDateString() === endTime.toDateString()){
      task.sessions.push({ start: nextStart.toISOString(), end: endTime.toISOString() });
    } else {
      let cursorStart = new Date(nextStart);
      while(cursorStart.toDateString() !== endTime.toDateString()){
        const fullDayEnd = new Date(cursorStart); fullDayEnd.setHours(23,59,59,999);
        task.sessions.push({ start: cursorStart.toISOString(), end: fullDayEnd.toISOString() });
        cursorStart.setDate(cursorStart.getDate() + 1); cursorStart.setHours(0,0,0,0);
      }
      task.sessions.push({ start: cursorStart.toISOString(), end: endTime.toISOString() });
    }
  } else {
    s.end = endTime.toISOString();
  }
  await saveData();
  render();
}

/* add task & live updates */
async function addTask(name){
  const trimmed = (name || '').trim();
  if(!trimmed) return;
  const newTask = { id: uid('task'), name: trimmed, sessions: [], createdAt: new Date().toISOString() };
  data.tasks.push(newTask);
  await saveData();
  render();
  newTaskInput.value = '';
  newTaskInput.focus();
}

function startLiveTimer(){
  if(liveTimerInterval) clearInterval(liveTimerInterval);
  liveTimerInterval = setInterval(()=> updateLiveDisplays(), 1000);
}
function updateLiveDisplays(){
  const iso = isoDate(currentDate);
  const cards = document.querySelectorAll('.task-card');
  data.tasks.forEach(t => {
    const card = Array.from(cards).find(c => c.dataset.id === t.id);
    if(!card) return;
    const meta = card.querySelector('.task-meta');
    const dur = durationSecondsForSessions(t.sessions || [], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    const prog = card.querySelector('.progress > i');
    if(prog) prog.style.width = Math.min(100, percentOfDaySeconds(dur)) + '%';
    // update stacked btn state
    const btns = card.querySelectorAll('.stack-btn');
    if(btns && btns.length >= 2){
      const running = hasRunningSession(t);
      btns[0].disabled = running ? true : false; // start
      btns[1].disabled = running ? false : true; // end
    }
  });
  const totalSec = data.tasks.reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions || [], iso), 0);
  totalTimeEl.textContent = 'Total: ' + secondsToHHMMSS(totalSec);
  totalPercentEl.textContent = percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}

/* CSV export & clear (drawer) */
function exportCsvForDate(dateIso){
  const header = ['Task Name','Session Start (ISO)','Session End (ISO)','Duration (seconds)','Duration (HH:MM:SS)','Percent of 24h'];
  const rows = [header];
  for(const t of data.tasks){
    for(const s of (t.sessions||[])){
      const dur = durationSecondsForSessions([s], dateIso);
      if(dur <= 0) continue;
      rows.push([t.name, s.start||'', s.end||'', String(Math.round(dur)), secondsToHHMMSS(dur), percentOfDaySeconds(dur).toFixed(4)+'%']);
    }
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`dnt_${currentUser?currentUser.uid:'guest'}_${dateIso}.csv`; a.click(); URL.revokeObjectURL(url);
}
async function clearDay(dateIso){ if(!confirm('Clear all tasks & sessions for this day?')) return; data={date:dateIso,tasks:[]}; await saveData(); render(); }

/* navigation */
async function shiftDays(delta){ const d = new Date(currentDate); d.setDate(d.getDate() + delta); await loadDate(d); }
async function jumpToToday(){ await loadDate(new Date()); }

/* persistence */
async function saveData(){ writeLocal(data); if(currentUser) await writeRemoteDay(currentUser.uid, data); }
async function loadDate(d){
  currentDate = new Date(d);
  const iso = isoDate(currentDate);
  dateDisplay.textContent = new Date(currentDate).toLocaleDateString(undefined, { weekday: 'short', month:'short', day:'numeric', year:'numeric' });
  if(currentUser){
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){ data = remote; writeLocal(data); } else { data = readLocal(iso); await writeRemoteDay(currentUser.uid, data); }
  } else {
    data = readLocal(iso);
  }
  render(); startLiveTimer(); renderAuthControls();
}

/* events */
addTaskBtn.addEventListener('click', ()=> addTask(newTaskInput.value));
fabAdd.addEventListener('click', ()=> addTask(newTaskInput.value || 'New Task'));
newTaskInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') addTask(newTaskInput.value); });
prevBtn.addEventListener('click', ()=> shiftDays(-1));
nextBtn.addEventListener('click', ()=> shiftDays(1));
todayBtn.addEventListener('click', ()=> jumpToToday());

/* drawer events */
hamburger.addEventListener('click', ()=> openDrawer());
drawerClose.addEventListener('click', ()=> closeDrawer());
drawerBackdrop.addEventListener('click', (e)=> { if(e.target === drawerBackdrop) closeDrawer(); });
drawerPrev.addEventListener('click', ()=> { shiftDays(-1); closeDrawer(); });
drawerToday.addEventListener('click', ()=> { jumpToToday(); closeDrawer(); });
drawerNext.addEventListener('click', ()=> { shiftDays(1); closeDrawer(); });
drawerExport.addEventListener('click', ()=> { exportCsvForDate(isoDate(currentDate)); closeDrawer(); });
drawerClear.addEventListener('click', ()=> { clearDay(isoDate(currentDate)); closeDrawer(); });

function openDrawer(){ drawerBackdrop.style.display='block'; drawerBackdrop.setAttribute('aria-hidden','false'); setTimeout(()=> drawer.classList.add('open'), 10); }
function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.setAttribute('aria-hidden','true'); setTimeout(()=> drawerBackdrop.style.display='none', 240); }

/* auth state listener */
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    const iso = isoDate(currentDate);
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){ data = remote; writeLocal(data); } else { const local = readLocal(iso); data = local; await writeRemoteDay(currentUser.uid, data); }
  } else {
    currentUser = null;
    data = readLocal(isoDate(currentDate));
  }
  renderAuthControls();
  await loadDate(currentDate);
});

/* init */
(async function init(){ renderAuthControls(); await loadDate(new Date()); })();

/* helper */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]) ); }

</script>
</body>
</html>