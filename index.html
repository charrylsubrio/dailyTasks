<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Non-Negotiable Tasks — Mobile (Firebase + Drawer)</title>
<style>
  :root{
    --bg:#f7f7f8;
    --panel:#ffffff;
    --muted:#6b6f73;
    --accent:#4c5055;
    --success:#2d9f6a;
    --danger:#e25353;
    --glass: rgba(76,80,85,0.06);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#111;padding:12px;box-sizing:border-box}
  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
  .header-left{display:flex;align-items:center;gap:10px;min-width:0}
  .hamburger{width:44px;height:44px;border-radius:10px;border:0;background:var(--panel);box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:center}
  .hamburger:focus{outline:2px solid rgba(76,80,85,0.14)}
  .title-wrap{flex:1;display:flex;flex-direction:column;align-items:center;min-width:0}
  h1{font-size:18px;margin:0;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .date-row{font-size:12px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  button.btn{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:10px;font-weight:700;min-width:42px}
  button.ghost{background:transparent;color:var(--accent);border:1px solid var(--glass)}
  /* Drawer */
  .drawer-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.35);z-index:80}
  .drawer{position:fixed;left:0;top:0;bottom:0;width:280px;background:var(--panel);box-shadow:8px 0 30px rgba(0,0,0,0.12);transform:translateX(-110%);transition:transform .22s ease;z-index:90;padding:14px;display:flex;flex-direction:column;gap:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .section{display:flex;flex-direction:column;gap:8px}
  .drawer .close{align-self:flex-end;padding:6px;border-radius:8px;border:0;background:transparent}
  .drawer .nav-btn{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:0;background:var(--bg);font-weight:700}
  /* main */
  main{display:flex;flex-direction:column;gap:12px;}
  .summary{background:linear-gradient(180deg,#fff,#fbfbfb);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;justify-content:space-between;align-items:center}
  .left{display:flex;flex-direction:column;}
  .big{font-size:16px;font-weight:700;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .task-list{display:flex;flex-direction:column;gap:10px;margin-bottom:88px}
  .task-card{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;flex-direction:column;gap:8px}
  .task-row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .task-title{font-weight:700;color:#111}
  .task-meta{font-size:12px;color:var(--muted)}
  .task-actions{display:flex;gap:8px}
  .btn-action{padding:8px 10px;border-radius:10px;border:0;font-weight:700}
  .btn-start{background:linear-gradient(90deg,var(--accent),#2f3336);color:#fff}
  .btn-end{background:var(--danger);color:#fff}
  .btn-delete{background:transparent;border:1px solid var(--glass);color:var(--muted)}
  .progress{height:8px;background:var(--glass);border-radius:6px;overflow:hidden;margin-top:6px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#6b6f73);width:0%}
  .fab{position:fixed;right:16px;bottom:18px;z-index:30}
  .fab button{width:56px;height:56px;border-radius:999px;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(76,80,85,0.14)}
  .inputs{display:flex;gap:8px}
  input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass);font-size:15px}
  @media(min-width:720px){ body{max-width:880px;margin:12px auto} .hamburger{display:none} .title-wrap{align-items:flex-start} .controls{display:flex} .drawer-backdrop{display:none} }
  /* Hide inline nav buttons on small screens (Option A) */
  @media (max-width: 720px) {
    #controls-inline button { display: none !important; }
  }
  /* small utilities */
  .muted{color:var(--muted);font-size:12px}
  .tiny{font-size:11px;color:var(--muted)}
  .running-dot{width:10px;height:10px;border-radius:20px;background:var(--success);display:inline-block;margin-right:6px;box-shadow:0 4px 10px rgba(45,159,106,0.2)}
  footer.smallprint{position:fixed;left:12px;bottom:10px;font-size:12px;color:var(--muted)}
  .user-badge{background:var(--glass);padding:6px 8px;border-radius:999px;color:var(--accent);font-weight:700}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <button class="hamburger" id="hamburger" aria-label="Open menu" title="Menu">
      <svg width="20" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect y="0" width="20" height="2" rx="1" fill="#4c5055"/>
        <rect y="6" width="20" height="2" rx="1" fill="#4c5055"/>
        <rect y="12" width="20" height="2" rx="1" fill="#4c5055"/>
      </svg>
    </button>
    <div class="title-wrap">
      <h1>Daily Non-Negotiable Tasks</h1>
      <div class="date-row" id="date-display">Loading date…</div>
    </div>
  </div>

  <div class="controls" id="controls-inline">
    <!-- These inline buttons will be hidden on small screens (see CSS). They still exist for desktop -->
    <button class="btn ghost" id="prev-day" title="Previous day">‹</button>
    <button class="btn" id="today" title="Jump to today">Today</button>
    <button class="btn ghost" id="next-day" title="Next day">›</button>
    <div id="user-area"><span class="tiny muted">Not signed in</span></div>
  </div>
</header>

<!-- Drawer overlay + menu -->
<div class="drawer-backdrop" id="drawer-backdrop" aria-hidden="true">
  <nav class="drawer" id="drawer" aria-label="Main menu">
    <button class="close" id="drawer-close" aria-label="Close menu">✕</button>

    <div class="section">
      <button class="nav-btn" id="drawer-prev">‹ Previous</button>
      <button class="nav-btn" id="drawer-today">Today</button>
      <button class="nav-btn" id="drawer-next">Next ›</button>
    </div>

    <div class="section">
      <button class="nav-btn" id="drawer-export">Export CSV</button>
      <button class="nav-btn" id="drawer-clear">Clear Day</button>
    </div>

    <div class="section" id="drawer-auth-area">
      <!-- auth buttons or user badge inserted here by JS -->
    </div>

    <div style="margin-top:auto;font-size:12px;color:var(--muted)">Stored locally (or in Firebase when signed in)</div>
  </nav>
</div>

<main>
  <div class="summary" aria-live="polite">
    <div class="left">
      <div class="big" id="total-time">Total: 00:00:00</div>
      <div class="small" id="total-percent">0.00% of 24 hours</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <button class="btn ghost" id="export-csv">Export CSV</button>
      <button class="btn" id="clear-day" title="Clear tasks for shown day">Clear</button>
    </div>
  </div>

  <div class="inputs">
    <input id="new-task-name" type="text" placeholder="Add a new task (e.g., 'Morning routine')" aria-label="New task name"/>
    <button class="btn" id="add-task">Add</button>
  </div>

  <section class="task-list" id="task-list" aria-live="polite">
    <!-- tasks -->
  </section>
</main>

<div class="fab" title="Add task quick">
  <button id="fab-add">+</button>
</div>

<footer class="smallprint">Stored in Firestore when signed in; cached locally when offline.</footer>

<!-- modal/backdrop + firebase code -->
<script type="module">
/* =========
   Firebase configuration (your config)
   ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBIwCmbfK4949rj4RKLTihhLtsvQzjwU-w",
  authDomain: "dailytasks-64e5a.firebaseapp.com",
  projectId: "dailytasks-64e5a",
  storageBucket: "dailytasks-64e5a.firebasestorage.app",
  messagingSenderId: "905259758762",
  appId: "1:905259758762:web:2da8fe74302022c39e4cd3",
  measurementId: "G-FKXHY4E8V5"
};

/* ---------- Firebase modular imports ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

/* Initialize Firebase */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- App state & UI refs ---------- */
const hamburger = document.getElementById('hamburger');
const drawerBackdrop = document.getElementById('drawer-backdrop');
const drawer = document.getElementById('drawer');
const drawerClose = document.getElementById('drawer-close');
const drawerPrev = document.getElementById('drawer-prev');
const drawerToday = document.getElementById('drawer-today');
const drawerNext = document.getElementById('drawer-next');
const drawerExport = document.getElementById('drawer-export');
const drawerClear = document.getElementById('drawer-clear');
const drawerAuthArea = document.getElementById('drawer-auth-area');

const dateDisplay = document.getElementById('date-display');
const taskListEl = document.getElementById('task-list');
const totalTimeEl = document.getElementById('total-time');
const totalPercentEl = document.getElementById('total-percent');
const newTaskInput = document.getElementById('new-task-name');
const addTaskBtn = document.getElementById('add-task');
const fabAdd = document.getElementById('fab-add');
const prevBtn = document.getElementById('prev-day');
const nextBtn = document.getElementById('next-day');
const todayBtn = document.getElementById('today');
const exportCsvBtn = document.getElementById('export-csv');
const clearDayBtn = document.getElementById('clear-day');
const controlsInline = document.getElementById('controls-inline');
const userArea = document.getElementById('user-area');

let currentDate = new Date();
let data = { date: isoDate(currentDate), tasks: [] };
let liveTimerInterval = null;
let currentUser = null;

/* ---------- Utility functions ---------- */
function isoDate(d){
  const t = new Date(d);
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,10);
}
function nowISO(){ return new Date().toISOString(); }
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,10); }
function secondsToHHMMSS(sec){
  sec = Math.max(0, Math.round(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return [h,m,s].map(n=>String(n).padStart(2,'0')).join(':');
}
function percentOfDaySeconds(sec){ return (sec/(24*3600))*100; }
function durationSecondsForSessions(sessions, dayIso = null){
  let total = 0;
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : new Date();
    if(!start) continue;
    if(dayIso){
      const dayStart = new Date(dayIso + 'T00:00:00');
      const dayEnd = new Date(dayIso + 'T23:59:59.999');
      const segStart = start > dayStart ? start : dayStart;
      const segEnd = end < dayEnd ? end : dayEnd;
      if(segEnd > segStart) total += (segEnd - segStart) / 1000;
    } else {
      if(end > start) total += (end - start) / 1000;
    }
  }
  return Math.max(0, total);
}

/* ---------- Firestore helpers ---------- */
function dayDocRef(uid, dateIso){ return doc(db, 'users', uid, 'days', dateIso); }
async function readRemoteDay(uid, dateIso){
  try{
    const snap = await getDoc(dayDocRef(uid, dateIso));
    if(snap.exists()) return snap.data();
    return null;
  }catch(err){
    console.warn('Firestore read error', err);
    return null;
  }
}
async function writeRemoteDay(uid, dayObj){
  try{
    await setDoc(dayDocRef(uid, dayObj.date), dayObj);
    return true;
  }catch(err){
    console.warn('Firestore write error', err);
    return false;
  }
}

/* ---------- Local cache fallback ---------- */
const LOCAL_PREFIX = 'dnt_tasks:';
function localKeyForDate(dateIso){ const userPart = currentUser ? `${currentUser.uid}:` : 'guest:'; return LOCAL_PREFIX + userPart + dateIso; }
function readLocal(dateIso){
  const raw = localStorage.getItem(localKeyForDate(dateIso));
  if(!raw) return { date: dateIso, tasks: [] };
  try { return JSON.parse(raw); } catch(e) { return { date: dateIso, tasks: [] }; }
}
function writeLocal(obj){ localStorage.setItem(localKeyForDate(obj.date), JSON.stringify(obj)); }

/* ---------- Rendering & Auth UI ---------- */
function renderAuthControls(){
  drawerAuthArea.innerHTML = '';
  Array.from(controlsInline.querySelectorAll('.auth-btn')).forEach(n=>n.remove());
  if(currentUser){
    const logout = document.createElement('button'); logout.className='btn ghost auth-btn'; logout.innerText='Logout'; logout.addEventListener('click', ()=> signOut(auth));
    const badge = document.createElement('div'); badge.className='user-badge auth-btn'; badge.innerText = currentUser.email || currentUser.uid;
    controlsInline.appendChild(badge); controlsInline.appendChild(logout);
    userArea.innerHTML = `<span class="tiny">Signed in</span> <span style="margin-left:8px" class="user-badge">${escapeHtml(currentUser.email || currentUser.uid)}</span>`;
    const drawerBadge = document.createElement('div'); drawerBadge.className='user-badge'; drawerBadge.innerText = currentUser.email || currentUser.uid;
    const drawerLogout = document.createElement('button'); drawerLogout.className='btn ghost'; drawerLogout.innerText='Logout'; drawerLogout.addEventListener('click', ()=> signOut(auth));
    drawerAuthArea.appendChild(drawerBadge); drawerAuthArea.appendChild(drawerLogout);
  } else {
    const reg = document.createElement('button'); reg.className='btn ghost auth-btn'; reg.innerText='Register'; reg.addEventListener('click', ()=> openAuthModal('register'));
    const login = document.createElement('button'); login.className='btn auth-btn'; login.innerText='Login'; login.addEventListener('click', ()=> openAuthModal('login'));
    controlsInline.appendChild(reg); controlsInline.appendChild(login);
    userArea.innerHTML = `<span class="tiny muted">Not signed in</span>`;
    const drawerReg = reg.cloneNode(true); drawerReg.addEventListener('click', ()=> openAuthModal('register'));
    const drawerLogin = login.cloneNode(true); drawerLogin.addEventListener('click', ()=> openAuthModal('login'));
    drawerAuthArea.appendChild(drawerLogin); drawerAuthArea.appendChild(drawerReg);
  }
}

/* ---------- Simple modal builder for auth ---------- */
function openAuthModal(mode='login'){
  const modalBackdrop = document.createElement('div');
  modalBackdrop.style.position='fixed'; modalBackdrop.style.inset='0'; modalBackdrop.style.background='rgba(0,0,0,0.35)'; modalBackdrop.style.zIndex='120';
  const modal = document.createElement('div'); modal.style.background='#fff'; modal.style.padding='16px'; modal.style.borderRadius='10px'; modal.style.width='92%'; modal.style.maxWidth='420px'; modal.style.margin='8% auto'; modal.setAttribute('role','dialog');
  if(mode==='register'){
    modal.innerHTML=`<h3>Create account</h3><div style="margin-top:8px"><input id="m-email" type="email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/><div style="height:8px"></div><input id="m-pass" type="password" placeholder="Password (min 6)" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/></div><div style="display:flex;gap:8px;margin-top:12px"><button id="m-create" class="btn">Create</button><button id="m-cancel" class="btn ghost">Cancel</button></div>`;
    document.body.appendChild(modalBackdrop); document.body.appendChild(modal);
    modalBackdrop.addEventListener('click', closeModal);
    document.getElementById('m-cancel').addEventListener('click', closeModal);
    document.getElementById('m-create').addEventListener('click', async ()=>{
      const e=document.getElementById('m-email').value.trim(), p=document.getElementById('m-pass').value;
      if(!e||!p||p.length<6){ alert('Provide email and password (min 6)'); return; }
      try{ await createUserWithEmailAndPassword(auth,e,p); closeModal(); }catch(err){ alert(err.message||err); }
    });
  } else {
    modal.innerHTML=`<h3>Login</h3><div style="margin-top:8px"><input id="m-email" type="email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/><div style="height:8px"></div><input id="m-pass" type="password" placeholder="Password" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)"/></div><div style="display:flex;gap:8px;margin-top:12px"><button id="m-login" class="btn">Login</button><button id="m-cancel" class="btn ghost">Cancel</button></div>`;
    document.body.appendChild(modalBackdrop); document.body.appendChild(modal);
    modalBackdrop.addEventListener('click', closeModal);
    document.getElementById('m-cancel').addEventListener('click', closeModal);
    document.getElementById('m-login').addEventListener('click', async ()=>{
      const e=document.getElementById('m-email').value.trim(), p=document.getElementById('m-pass').value;
      if(!e||!p){ alert('Provide email & password'); return; }
      try{ await signInWithEmailAndPassword(auth,e,p); closeModal(); }catch(err){ alert(err.message||err); }
    });
  }
  function closeModal(){ if(modal.parentNode) modal.remove(); if(modalBackdrop.parentNode) modalBackdrop.remove(); }
}

/* ---------- Task rendering & session helpers ---------- */
function render(){
  const iso = isoDate(currentDate);
  taskListEl.innerHTML = '';
  data.tasks = data.tasks || [];
  data.tasks.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
  for(const t of data.tasks){
    const card = document.createElement('article'); card.className='task-card'; card.dataset.id=t.id;
    const row = document.createElement('div'); row.className='task-row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
    const titleRow = document.createElement('div'); titleRow.style.display='flex'; titleRow.style.alignItems='center'; titleRow.style.gap='8px';
    const running = hasRunningSession(t);
    if(running){ const dot=document.createElement('span'); dot.className='running-dot'; titleRow.appendChild(dot); }
    const title = document.createElement('span'); title.className='task-title'; title.contentEditable=true; title.spellcheck=false; title.innerText=t.name||'Untitled task'; title.style.outline='none';
    title.addEventListener('blur', ()=>{ t.name = title.innerText.trim() || 'Untitled task'; saveData(); });
    title.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); title.blur(); }});
    titleRow.appendChild(title); left.appendChild(titleRow);
    const meta = document.createElement('div'); meta.className='task-meta'; const dur = durationSecondsForSessions(t.sessions||[], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    left.appendChild(meta); row.appendChild(left);
    const actions = document.createElement('div'); actions.className='task-actions';
    const startBtn = document.createElement('button'); startBtn.className='btn-action btn-start'; startBtn.innerText=running?'Running':'Start'; startBtn.disabled=running; startBtn.addEventListener('click', ()=> startSession(t));
    const endBtn = document.createElement('button'); endBtn.className='btn-action btn-end'; endBtn.innerText='End'; endBtn.addEventListener('click', ()=> endSession(t));
    const delBtn = document.createElement('button'); delBtn.className='btn-action btn-delete'; delBtn.innerText='Delete'; delBtn.addEventListener('click', async ()=> { if(confirm('Delete this task?')){ data.tasks=data.tasks.filter(x=>x.id!==t.id); await saveData(); render(); }});
    actions.appendChild(startBtn); actions.appendChild(endBtn); actions.appendChild(delBtn); row.appendChild(actions);
    card.appendChild(row);
    const progressWrap = document.createElement('div'); progressWrap.className='progress';
    const progressInner=document.createElement('i'); progressInner.style.width = Math.min(100, percentOfDaySeconds(dur)) + '%';
    progressWrap.appendChild(progressInner); card.appendChild(progressWrap); taskListEl.appendChild(card);
  }
  const totalSec = (data.tasks||[]).reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions||[], iso),0);
  totalTimeEl.textContent='Total: '+secondsToHHMMSS(totalSec);
  totalPercentEl.textContent= percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}
function lastSessionTimesText(task, dayIso){
  const iso = dayIso || isoDate(currentDate);
  const sessions = (task.sessions || []).slice().reverse();
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : (s.start ? new Date() : null);
    if(!start) continue;
    const dayStart = new Date(iso + 'T00:00:00');
    const dayEnd = new Date(iso + 'T23:59:59.999');
    const segStart = start > dayStart ? start : dayStart;
    const segEnd = end < dayEnd ? end : dayEnd;
    if(segEnd > segStart){
      return `Start: ${segStart.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} • End: ${s.end ? segEnd.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '—'}`;
    }
  }
  return 'Start: — • End: —';
}
function hasRunningSession(task){ return (task.sessions||[]).some(s => s.start && !s.end); }

async function startSession(task){
  if(hasRunningSession(task)){ alert('This task already has a running session. End it first.'); return; }
  const s = { start: nowISO(), end: null };
  task.sessions = task.sessions || [];
  task.sessions.push(s);
  await saveData();
  render();
}
async function endSession(task){
  const sessions = task.sessions || [];
  const idx = sessions.map(s=>s.start && !s.end ? 1:0).lastIndexOf(1);
  if(idx === -1){ alert('No running session found.'); return; }
  const s = sessions[idx];
  const endTime = new Date();
  const startTime = new Date(s.start);
  if(startTime.toDateString() !== endTime.toDateString()){
    const endOfStartDay = new Date(startTime); endOfStartDay.setHours(23,59,59,999); s.end = endOfStartDay.toISOString();
    let nextStart = new Date(startTime); nextStart.setDate(nextStart.getDate() + 1); nextStart.setHours(0,0,0,0);
    if(nextStart.toDateString() === endTime.toDateString()){
      task.sessions.push({ start: nextStart.toISOString(), end: endTime.toISOString() });
    } else {
      let cursorStart = new Date(nextStart);
      while(cursorStart.toDateString() !== endTime.toDateString()){
        const fullDayEnd = new Date(cursorStart); fullDayEnd.setHours(23,59,59,999);
        task.sessions.push({ start: cursorStart.toISOString(), end: fullDayEnd.toISOString() });
        cursorStart.setDate(cursorStart.getDate() + 1);
        cursorStart.setHours(0,0,0,0);
      }
      task.sessions.push({ start: cursorStart.toISOString(), end: endTime.toISOString() });
    }
  } else {
    s.end = endTime.toISOString();
  }
  await saveData();
  render();
}

/* ---------- add task & persistence ---------- */
async function addTask(name){
  const trimmed = (name || '').trim();
  if(!trimmed) return;
  const newTask = { id: uid('task'), name: trimmed, sessions: [], createdAt: new Date().toISOString() };
  data.tasks.push(newTask);
  await saveData();
  render();
  newTaskInput.value = '';
  newTaskInput.focus();
}

function startLiveTimer(){
  if(liveTimerInterval) clearInterval(liveTimerInterval);
  liveTimerInterval = setInterval(()=> {
    updateLiveDisplays();
  }, 1000);
}
function updateLiveDisplays(){
  const iso = isoDate(currentDate);
  const cards = document.querySelectorAll('.task-card');
  data.tasks.forEach(t => {
    const card = Array.from(cards).find(c => c.dataset.id === t.id);
    if(!card) return;
    const meta = card.querySelector('.task-meta');
    const dur = durationSecondsForSessions(t.sessions || [], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    const prog = card.querySelector('.progress > i');
    if(prog) { prog.style.width = Math.min(100, percentOfDaySeconds(dur)) + '%'; }
    const btnStart = card.querySelector('.btn-start');
    const running = hasRunningSession(t);
    btnStart.disabled = running;
    btnStart.innerText = running ? 'Running' : 'Start';
  });
  const totalSec = data.tasks.reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions || [], iso), 0);
  totalTimeEl.textContent = 'Total: ' + secondsToHHMMSS(totalSec);
  totalPercentEl.textContent = percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}

/* ---------- load/save day (local + remote) ---------- */
async function loadDate(d){
  currentDate = new Date(d);
  const iso = isoDate(currentDate);
  dateDisplay.textContent = new Date(currentDate).toLocaleDateString(undefined, { weekday: 'short', month:'short', day:'numeric', year:'numeric' });
  if(currentUser){
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){
      data = remote;
      writeLocal(data);
    } else {
      data = readLocal(iso);
      await writeRemoteDay(currentUser.uid, data);
    }
  } else {
    data = readLocal(iso);
  }
  render();
  startLiveTimer();
  renderAuthControls();
}
async function saveData(){
  writeLocal(data);
  if(currentUser){
    await writeRemoteDay(currentUser.uid, data);
  }
}

/* ---------- CSV export & clear ---------- */
function exportCsvForDate(dateIso){
  const header = ['Task Name','Session Start (ISO)','Session End (ISO)','Duration (seconds)','Duration (HH:MM:SS)','Percent of 24h'];
  const rows = [header];
  for(const t of data.tasks){
    for(const s of (t.sessions||[])){
      const dur = durationSecondsForSessions([s], dateIso);
      if(dur <= 0) continue;
      rows.push([t.name, s.start || '', s.end || '', String(Math.round(dur)), secondsToHHMMSS(dur), percentOfDaySeconds(dur).toFixed(4) + '%']);
    }
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dnt_${currentUser?currentUser.uid:'guest'}_${dateIso}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
async function clearDay(dateIso){
  if(!confirm('Clear all tasks & sessions for this day? This cannot be undone.')) return;
  data = { date: dateIso, tasks: [] };
  await saveData();
  render();
}

/* ---------- navigation ---------- */
async function shiftDays(delta){ const d = new Date(currentDate); d.setDate(d.getDate() + delta); await loadDate(d); }
async function jumpToToday(){ await loadDate(new Date()); }

/* ---------- events ---------- */
addTaskBtn.addEventListener('click', ()=> addTask(newTaskInput.value));
fabAdd.addEventListener('click', ()=> addTask(newTaskInput.value || 'New Task'));
newTaskInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') addTask(newTaskInput.value); });
prevBtn.addEventListener('click', ()=> shiftDays(-1));
nextBtn.addEventListener('click', ()=> shiftDays(1));
todayBtn.addEventListener('click', ()=> jumpToToday());
exportCsvBtn.addEventListener('click', ()=> exportCsvForDate(isoDate(currentDate)));
clearDayBtn.addEventListener('click', ()=> clearDay(isoDate(currentDate)));

/* ---------- drawer events ---------- */
hamburger.addEventListener('click', ()=> openDrawer());
drawerClose.addEventListener('click', ()=> closeDrawer());
drawerBackdrop.addEventListener('click', (e)=> { if(e.target === drawerBackdrop) closeDrawer(); });
drawerPrev.addEventListener('click', ()=> { shiftDays(-1); closeDrawer(); });
drawerToday.addEventListener('click', ()=> { jumpToToday(); closeDrawer(); });
drawerNext.addEventListener('click', ()=> { shiftDays(1); closeDrawer(); });
drawerExport.addEventListener('click', ()=> { exportCsvForDate(isoDate(currentDate)); closeDrawer(); });
drawerClear.addEventListener('click', ()=> { clearDay(isoDate(currentDate)); closeDrawer(); });

function openDrawer(){ drawerBackdrop.style.display='block'; drawerBackdrop.setAttribute('aria-hidden','false'); setTimeout(()=> drawer.classList.add('open'), 10); }
function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.setAttribute('aria-hidden','true'); setTimeout(()=> drawerBackdrop.style.display='none', 240); }

/* ---------- auth listener & sync ---------- */
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    const iso = isoDate(currentDate);
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){
      data = remote;
      writeLocal(data);
    } else {
      data = readLocal(iso);
      await writeRemoteDay(currentUser.uid, data);
    }
  } else {
    currentUser = null;
    data = readLocal(isoDate(currentDate));
  }
  renderAuthControls();
  await loadDate(currentDate);
});

/* ---------- init ---------- */
(async function init(){
  renderAuthControls();
  await loadDate(new Date());
})();

/* ---------- helper ---------- */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g,(m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]) ); }

</script>
</body>
</html>