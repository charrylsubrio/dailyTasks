<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Non-Negotiable Tasks — Mobile (Firebase)</title>
<style>
  :root{
    --bg:#f7f7f8;
    --panel:#ffffff;
    --muted:#6b6f73;
    --accent:#4c5055;
    --success:#2d9f6a;
    --danger:#e25353;
    --glass: rgba(76,80,85,0.06);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#111;padding:16px;box-sizing:border-box}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .header-left{display:flex;flex-direction:column;gap:6px;}
  h1{font-size:20px;margin:0;color:var(--accent);}
  .date-row{font-size:13px;color:var(--muted);margin-top:2px;}
  .controls{display:flex;gap:8px;align-items:center;}
  button.btn{background:var(--accent);color:#fff;border:0;padding:10px 12px;border-radius:12px;font-weight:600;min-width:44px}
  button.ghost{background:transparent;color:var(--accent);border:1px solid var(--glass)}
  main{display:flex;flex-direction:column;gap:12px;}
  .summary{background:linear-gradient(180deg,#fff,#fbfbfb);padding:12px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;justify-content:space-between;align-items:center}
  .left{display:flex;flex-direction:column;}
  .big{font-size:16px;font-weight:700;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .task-list{display:flex;flex-direction:column;gap:10px;margin-bottom:88px}
  .task-card{background:var(--panel);padding:12px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.03);display:flex;flex-direction:column;gap:8px}
  .task-row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .task-title{font-weight:700;color:#111}
  .task-meta{font-size:12px;color:var(--muted)}
  .task-actions{display:flex;gap:8px}
  .btn-action{padding:8px 10px;border-radius:10px;border:0;font-weight:700}
  .btn-start{background:linear-gradient(90deg,var(--accent),#2f3336);color:#fff}
  .btn-end{background:var(--danger);color:#fff}
  .btn-delete{background:transparent;border:1px solid var(--glass);color:var(--muted)}
  .progress{height:8px;background:var(--glass);border-radius:6px;overflow:hidden;margin-top:6px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#6b6f73);width:0%}
  .fab{position:fixed;right:16px;bottom:18px;z-index:30}
  .fab button{width:56px;height:56px;border-radius:999px;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(76,80,85,0.14)}
  .inputs{display:flex;gap:8px}
  input[type="text"], input[type="email"], input[type="password"]{flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass);font-size:15px}
  @media(min-width:700px){ body{max-width:720px;margin:12px auto} }
  .muted{color:var(--muted);font-size:12px}
  .tiny{font-size:11px;color:var(--muted)}
  .running-dot{width:10px;height:10px;border-radius:20px;background:var(--success);display:inline-block;margin-right:6px;box-shadow:0 4px 10px rgba(45,159,106,0.2)}
  footer.smallprint{position:fixed;left:16px;bottom:10px;font-size:12px;color:var(--muted)}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:#fff;padding:18px;border-radius:12px;width:92%;max-width:420px;box-shadow:0 12px 36px rgba(0,0,0,0.2)}
  .row{display:flex;gap:8px;margin-top:8px}
  .small-link{background:transparent;border:0;color:var(--accent);font-weight:700}
  .user-badge{background:var(--glass);padding:6px 8px;border-radius:999px;color:var(--accent);font-weight:700}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <h1>Daily Non-Negotiable Tasks</h1>
    <div style="display:flex;align-items:center;gap:8px">
      <div id="user-area"><span class="tiny muted">Not signed in</span></div>
      <div class="date-row" id="date-display">Loading date…</div>
    </div>
  </div>

  <div class="controls" id="controls">
    <button class="btn ghost" id="prev-day" title="Previous day">‹</button>
    <button class="btn" id="today" title="Jump to today">Today</button>
    <button class="btn ghost" id="next-day" title="Next day">›</button>
    <!-- auth buttons inserted dynamically -->
  </div>
</header>

<main>
  <div class="summary" aria-live="polite">
    <div class="left">
      <div class="big" id="total-time">Total: 00:00:00</div>
      <div class="small" id="total-percent">0.00% of 24 hours</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <button class="btn ghost" id="export-csv">Export CSV</button>
      <button class="btn" id="clear-day" title="Clear tasks for shown day">Clear</button>
    </div>
  </div>

  <div class="inputs">
    <input id="new-task-name" type="text" placeholder="Add a new task (e.g., 'Morning routine')" aria-label="New task name"/>
    <button class="btn" id="add-task">Add</button>
  </div>

  <section class="task-list" id="task-list" aria-live="polite">
    <!-- task cards inserted here -->
  </section>
</main>

<div class="fab" title="Add task quick">
  <button id="fab-add">+</button>
</div>

<footer class="smallprint">Stored in Firestore when signed in; cached locally when offline.</footer>

<div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" id="auth-modal"></div>
</div>

<!-- Firebase (modular) via CDN -->
<script type="module">
/* =========
   Replace-only: firebaseConfig (from you) is used below. Do NOT share this publicly if sensitive.
   ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBIwCmbfK4949rj4RKLTihhLtsvQzjwU-w",
  authDomain: "dailytasks-64e5a.firebaseapp.com",
  projectId: "dailytasks-64e5a",
  storageBucket: "dailytasks-64e5a.firebasestorage.app",
  messagingSenderId: "905259758762",
  appId: "1:905259758762:web:2da8fe74302022c39e4cd3",
  measurementId: "G-FKXHY4E8V5"
};

/* ---------- Firebase imports (modular) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

/* ---------- Initialize Firebase ---------- */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= Application code (mostly same UI & logic as before) ========= */

const ONE_DAY_SECONDS = 24 * 3600;
const LOCAL_PREFIX = 'dnt_tasks:'; // local cache prefix when offline or signed out

// UI references
const dateDisplay = document.getElementById('date-display');
const taskListEl = document.getElementById('task-list');
const totalTimeEl = document.getElementById('total-time');
const totalPercentEl = document.getElementById('total-percent');
const newTaskInput = document.getElementById('new-task-name');
const addTaskBtn = document.getElementById('add-task');
const fabAdd = document.getElementById('fab-add');
const prevBtn = document.getElementById('prev-day');
const nextBtn = document.getElementById('next-day');
const todayBtn = document.getElementById('today');
const exportCsvBtn = document.getElementById('export-csv');
const clearDayBtn = document.getElementById('clear-day');
const controls = document.getElementById('controls');
const userArea = document.getElementById('user-area');
const modalBackdrop = document.getElementById('modal-backdrop');
const authModal = document.getElementById('auth-modal');

let currentDate = new Date();
let data = { date: isoDate(currentDate), tasks: [] };
let liveTimerInterval = null;
let currentUser = null; // firebase user object

/* ---------- Utility functions ---------- */
function isoDate(d){
  const t = new Date(d);
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,10);
}
function nowISO(){ return new Date().toISOString(); }
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,10); }
function secondsToHHMMSS(sec){
  sec = Math.max(0, Math.round(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return [h,m,s].map(n=>String(n).padStart(2,'0')).join(':');
}
function percentOfDaySeconds(sec){ return (sec/(24*3600))*100; }

/* ---------- Local cache (fallback) ---------- */
function localKeyForDate(dateIso){
  // if signed in, we still maintain local cache keyed by user to avoid collision
  const userPart = currentUser ? `${currentUser.uid}:` : 'guest:';
  return LOCAL_PREFIX + userPart + dateIso;
}
function readLocal(dateIso){
  const raw = localStorage.getItem(localKeyForDate(dateIso));
  if(!raw) return { date: dateIso, tasks: [] };
  try { return JSON.parse(raw); } catch(e) { return { date: dateIso, tasks: [] }; }
}
function writeLocal(obj){
  localStorage.setItem(localKeyForDate(obj.date), JSON.stringify(obj));
}

/* ---------- Firestore helpers ---------- */
function dayDocRef(uid, dateIso){
  // path: users/{uid}/days/{dateIso}
  return doc(db, 'users', uid, 'days', dateIso);
}
async function readRemoteDay(uid, dateIso){
  try{
    const dref = dayDocRef(uid, dateIso);
    const snap = await getDoc(dref);
    if(snap.exists()) return snap.data(); // should contain { date, tasks: [...] }
    return null;
  }catch(err){
    console.warn('Firestore read error', err);
    return null;
  }
}
async function writeRemoteDay(uid, dayObj){
  try{
    const dref = dayDocRef(uid, dayObj.date);
    // use setDoc (overwrites) - you may change to merge/update as needed
    await setDoc(dref, dayObj);
    return true;
  }catch(err){
    console.warn('Firestore write error', err);
    return false;
  }
}

/* ---------- Time calculations (same as before) ---------- */
function durationSecondsForSessions(sessions, dayIso = null){
  let total = 0;
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : new Date();
    if(!start) continue;
    if(dayIso){
      const dayStart = new Date(dayIso + 'T00:00:00');
      const dayEnd = new Date(dayIso + 'T23:59:59.999');
      const segStart = start > dayStart ? start : dayStart;
      const segEnd = end < dayEnd ? end : dayEnd;
      if(segEnd > segStart) total += (segEnd - segStart) / 1000;
    } else {
      if(end > start) total += (end - start) / 1000;
    }
  }
  return Math.max(0, total);
}

/* ---------- Rendering ---------- */
function renderAuthControls(){
  Array.from(controls.querySelectorAll('.auth-btn')).forEach(n => n.remove());
  if(currentUser){
    const logout = document.createElement('button');
    logout.className = 'btn ghost auth-btn';
    logout.innerText = 'Logout';
    logout.addEventListener('click', async ()=> {
      await signOut(auth);
    });
    const badge = document.createElement('div');
    badge.className = 'user-badge auth-btn';
    badge.innerText = currentUser.email || currentUser.uid;
    controls.appendChild(badge);
    controls.appendChild(logout);
    userArea.innerHTML = `<span class="tiny">Signed in</span> <span style="margin-left:8px" class="user-badge">${escapeHtml(currentUser.email || currentUser.uid)}</span>`;
  } else {
    const reg = document.createElement('button');
    reg.className = 'btn ghost auth-btn';
    reg.innerText = 'Register';
    reg.addEventListener('click', () => openAuthModal('register'));
    const login = document.createElement('button');
    login.className = 'btn auth-btn';
    login.innerText = 'Login';
    login.addEventListener('click', () => openAuthModal('login'));
    controls.appendChild(reg);
    controls.appendChild(login);
    userArea.innerHTML = `<span class="tiny muted">Not signed in</span>`;
  }
}

function openAuthModal(mode='login'){
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  authModal.innerHTML = '';
  if(mode === 'register'){
    authModal.innerHTML = `
      <h3>Create account</h3>
      <div class="small muted">Use an email & password. Data will sync to your Firebase account.</div>
      <div style="margin-top:12px">
        <input id="reg-email" type="email" placeholder="Email" />
        <div style="height:8px"></div>
        <input id="reg-password" type="password" placeholder="Password (min 6)" />
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="reg-create">Create</button>
        <button class="btn ghost" id="reg-cancel">Cancel</button>
      </div>
      <div style="margin-top:8px">
        <button class="small-link" id="switch-to-login">Already have an account? Login</button>
      </div>
    `;
    document.getElementById('reg-cancel').addEventListener('click', closeModal);
    document.getElementById('switch-to-login').addEventListener('click', ()=> openAuthModal('login'));
    document.getElementById('reg-create').addEventListener('click', async ()=>{
      const e = document.getElementById('reg-email').value.trim();
      const p = document.getElementById('reg-password').value;
      if(!e || !p){ alert('Fill both fields.'); return; }
      if(p.length < 6){ alert('Password must be at least 6 characters.'); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, e, p);
        // created & signed in automatically — auth state listener will handle UI and sync
        closeModal();
      }catch(err){
        alert('Register error: ' + (err.message || err));
      }
    });
    setTimeout(()=> document.getElementById('reg-email').focus(), 100);
  } else {
    authModal.innerHTML = `
      <h3>Login</h3>
      <div class="small muted">Login to sync tasks (email/password).</div>
      <div style="margin-top:12px">
        <input id="login-email" type="email" placeholder="Email" />
        <div style="height:8px"></div>
        <input id="login-password" type="password" placeholder="Password" />
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="login-go">Login</button>
        <button class="btn ghost" id="login-cancel">Cancel</button>
      </div>
      <div style="margin-top:8px">
        <button class="small-link" id="switch-to-register">Create an account</button>
      </div>
    `;
    document.getElementById('login-cancel').addEventListener('click', closeModal);
    document.getElementById('switch-to-register').addEventListener('click', ()=> openAuthModal('register'));
    document.getElementById('login-go').addEventListener('click', async ()=>{
      const e = document.getElementById('login-email').value.trim();
      const p = document.getElementById('login-password').value;
      if(!e || !p){ alert('Provide email and password'); return; }
      try{
        await signInWithEmailAndPassword(auth, e, p);
        // signed in — auth state listener will handle the rest
        closeModal();
      }catch(err){
        alert('Login error: ' + (err.message || err));
      }
    });
    setTimeout(()=> document.getElementById('login-email').focus(), 100);
  }
}
function closeModal(){ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); authModal.innerHTML = ''; }
modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });

/* ---------- Core: load/save day locally and remotely ---------- */
async function loadDate(d){
  currentDate = new Date(d);
  const iso = isoDate(currentDate);
  dateDisplay.textContent = new Date(currentDate).toLocaleDateString(undefined, { weekday: 'short', month:'short', day:'numeric', year:'numeric' });
  // try remote if signed in
  if(currentUser){
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){
      data = remote;
      // update local cache
      writeLocal(data);
    } else {
      // remote empty -> check local cache
      data = readLocal(iso);
      // and push local to remote (create doc) so user has initial copy
      await writeRemoteDay(currentUser.uid, data);
    }
  } else {
    // guest -> local only
    data = readLocal(iso);
  }
  render();
  startLiveTimer();
  renderAuthControls();
}

async function saveData(){
  // always write local cache
  writeLocal(data);
  // if signed in, also write to Firestore (best-effort)
  if(currentUser){
    await writeRemoteDay(currentUser.uid, data);
  }
}

/* ---------- Rendering tasks UI ---------- */
function render(){
  const iso = isoDate(currentDate);
  taskListEl.innerHTML = '';
  data.tasks = data.tasks || [];
  data.tasks.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
  for(const t of data.tasks){
    const card = document.createElement('article');
    card.className = 'task-card';
    card.dataset.id = t.id;
    const row = document.createElement('div');
    row.className = 'task-row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
    const titleRow = document.createElement('div'); titleRow.style.display='flex'; titleRow.style.alignItems='center'; titleRow.style.gap='8px';
    const running = hasRunningSession(t);
    if(running){ const dot = document.createElement('span'); dot.className = 'running-dot'; titleRow.appendChild(dot); }
    const title = document.createElement('span'); title.className = 'task-title';
    title.contentEditable = true; title.spellcheck = false; title.innerText = t.name || 'Untitled task'; title.style.outline='none';
    title.addEventListener('blur', ()=> { t.name = title.innerText.trim() || 'Untitled task'; saveData(); });
    title.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter'){ ev.preventDefault(); title.blur(); }});
    titleRow.appendChild(title); left.appendChild(titleRow);
    const meta = document.createElement('div'); meta.className = 'task-meta';
    const dur = durationSecondsForSessions(t.sessions || [], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    left.appendChild(meta);
    row.appendChild(left);
    const actions = document.createElement('div'); actions.className = 'task-actions';
    const startBtn = document.createElement('button'); startBtn.className = 'btn-action btn-start'; startBtn.innerText = running ? 'Running' : 'Start'; startBtn.disabled = running;
    startBtn.addEventListener('click', ()=> { startSession(t); });
    const endBtn = document.createElement('button'); endBtn.className = 'btn-action btn-end'; endBtn.innerText = 'End'; endBtn.addEventListener('click', ()=> { endSession(t); });
    const delBtn = document.createElement('button'); delBtn.className = 'btn-action btn-delete'; delBtn.innerText = 'Delete'; delBtn.addEventListener('click', async ()=>{
      if(confirm('Delete this task and its sessions?')) {
        data.tasks = data.tasks.filter(x=>x.id !== t.id);
        await saveData();
        render();
      }
    });
    actions.appendChild(startBtn); actions.appendChild(endBtn); actions.appendChild(delBtn);
    row.appendChild(actions);
    card.appendChild(row);
    const progressWrap = document.createElement('div'); progressWrap.className = 'progress';
    const progressInner = document.createElement('i');
    const pct = Math.min(100, percentOfDaySeconds(dur));
    progressInner.style.width = pct + '%';
    progressWrap.appendChild(progressInner);
    card.appendChild(progressWrap);
    taskListEl.appendChild(card);
  }

  const totalSec = (data.tasks || []).reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions || [], iso), 0);
  totalTimeEl.textContent = 'Total: ' + secondsToHHMMSS(totalSec);
  totalPercentEl.textContent = percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}

/* ---------- session helpers ---------- */
function lastSessionTimesText(task, dayIso){
  const iso = dayIso || isoDate(currentDate);
  const sessions = (task.sessions || []).slice().reverse();
  for(const s of sessions){
    const start = s.start ? new Date(s.start) : null;
    const end = s.end ? new Date(s.end) : (s.start ? new Date() : null);
    if(!start) continue;
    const dayStart = new Date(iso + 'T00:00:00');
    const dayEnd = new Date(iso + 'T23:59:59.999');
    const segStart = start > dayStart ? start : dayStart;
    const segEnd = end < dayEnd ? end : dayEnd;
    if(segEnd > segStart){
      return `Start: ${segStart.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} • End: ${s.end ? segEnd.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '—'}`;
    }
  }
  return 'Start: — • End: —';
}
function hasRunningSession(task){ return (task.sessions||[]).some(s => s.start && !s.end); }

async function startSession(task){
  if(hasRunningSession(task)){ alert('This task already has a running session. End it first.'); return; }
  const s = { start: nowISO(), end: null };
  task.sessions = task.sessions || [];
  task.sessions.push(s);
  await saveData();
  render();
}
async function endSession(task){
  const sessions = task.sessions || [];
  const idx = sessions.map(s=>s.start && !s.end ? 1:0).lastIndexOf(1);
  if(idx === -1){ alert('No running session found. Press Start first.'); return; }
  const s = sessions[idx];
  const endTime = new Date();
  const startTime = new Date(s.start);
  if(startTime.toDateString() !== endTime.toDateString()){
    const endOfStartDay = new Date(startTime); endOfStartDay.setHours(23,59,59,999); s.end = endOfStartDay.toISOString();
    let nextStart = new Date(startTime); nextStart.setDate(nextStart.getDate() + 1); nextStart.setHours(0,0,0,0);
    if(nextStart.toDateString() === endTime.toDateString()){
      task.sessions.push({ start: nextStart.toISOString(), end: endTime.toISOString() });
    } else {
      let cursorStart = new Date(nextStart);
      while(cursorStart.toDateString() !== endTime.toDateString()){
        const fullDayEnd = new Date(cursorStart); fullDayEnd.setHours(23,59,59,999);
        task.sessions.push({ start: cursorStart.toISOString(), end: fullDayEnd.toISOString() });
        cursorStart.setDate(cursorStart.getDate() + 1); cursorStart.setHours(0,0,0,0);
      }
      task.sessions.push({ start: cursorStart.toISOString(), end: endTime.toISOString() });
    }
  } else {
    s.end = endTime.toISOString();
  }
  await saveData();
  render();
}

/* ---------- Add task & live timer ---------- */
async function addTask(name){
  const trimmed = (name || '').trim();
  if(!trimmed) return;
  const newTask = { id: uid('task'), name: trimmed, sessions: [], createdAt: new Date().toISOString() };
  data.tasks.push(newTask);
  await saveData();
  render();
  newTaskInput.value = '';
  newTaskInput.focus();
}

function startLiveTimer(){
  if(liveTimerInterval) clearInterval(liveTimerInterval);
  liveTimerInterval = setInterval(()=> updateLiveDisplays(), 1000);
}
function updateLiveDisplays(){
  const iso = isoDate(currentDate);
  const cards = document.querySelectorAll('.task-card');
  data.tasks.forEach(t => {
    const card = Array.from(cards).find(c => c.dataset.id === t.id);
    if(!card) return;
    const meta = card.querySelector('.task-meta');
    const dur = durationSecondsForSessions(t.sessions || [], iso);
    meta.innerText = `${lastSessionTimesText(t, iso)} • ${secondsToHHMMSS(dur)} • ${percentOfDaySeconds(dur).toFixed(2)}%`;
    const prog = card.querySelector('.progress > i'); if(prog) prog.style.width = Math.min(100, percentOfDaySeconds(dur)) + '%';
    const btnStart = card.querySelector('.btn-start'); const running = hasRunningSession(t); btnStart.disabled = running; btnStart.innerText = running ? 'Running' : 'Start';
  });
  const totalSec = (data.tasks || []).reduce((acc,t)=> acc + durationSecondsForSessions(t.sessions || [], iso), 0);
  totalTimeEl.textContent = 'Total: ' + secondsToHHMMSS(totalSec);
  totalPercentEl.textContent = percentOfDaySeconds(totalSec).toFixed(2) + '% of 24 hours';
}

/* ---------- CSV export & clear ---------- */
function exportCsvForDate(dateIso){
  const header = ['Task Name','Session Start (ISO)','Session End (ISO)','Duration (seconds)','Duration (HH:MM:SS)','Percent of 24h'];
  const rows = [header];
  const dayData = data; // already loaded for current date
  for(const t of (dayData.tasks||[])){
    for(const s of (t.sessions||[])){
      const dur = durationSecondsForSessions([s], dateIso);
      if(dur <= 0) continue;
      rows.push([t.name, s.start || '', s.end || '', String(Math.round(dur)), secondsToHHMMSS(dur), percentOfDaySeconds(dur).toFixed(4) + '%']);
    }
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `dnt_${currentUser?currentUser.uid:'guest'}_${dateIso}.csv`; a.click(); URL.revokeObjectURL(url);
}

async function clearDay(dateIso){
  if(!confirm('Clear all tasks & sessions for this day? This cannot be undone.')) return;
  data = { date: dateIso, tasks: [] };
  await saveData();
  render();
}

/* ---------- Navigation ---------- */
async function shiftDays(delta){
  const d = new Date(currentDate); d.setDate(d.getDate() + delta); await loadDate(d);
}
async function jumpToToday(){ await loadDate(new Date()); }

/* ---------- Events ---------- */
addTaskBtn.addEventListener('click', ()=> addTask(newTaskInput.value));
fabAdd.addEventListener('click', ()=> addTask(newTaskInput.value || 'New Task')); // fast flow preserved
newTaskInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') addTask(newTaskInput.value); });
prevBtn.addEventListener('click', ()=> shiftDays(-1));
nextBtn.addEventListener('click', ()=> shiftDays(1));
todayBtn.addEventListener('click', ()=> jumpToToday());
exportCsvBtn.addEventListener('click', ()=> exportCsvForDate(isoDate(currentDate)));
clearDayBtn.addEventListener('click', ()=> clearDay(isoDate(currentDate)));

/* ---------- Auth state listener: sync on sign-in ---------- */
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    // when user signs in: attempt to merge local guest cache into remote or load remote
    const iso = isoDate(currentDate);
    const remote = await readRemoteDay(currentUser.uid, iso);
    if(remote){
      data = remote;
      writeLocal(data); // cache locally
    } else {
      // no remote document: push local cache to cloud (merge)
      const local = readLocal(iso);
      data = local;
      await writeRemoteDay(currentUser.uid, data);
    }
  } else {
    currentUser = null;
    // load as guest from local
    data = readLocal(isoDate(currentDate));
  }
  renderAuthControls();
  await loadDate(currentDate);
});

/* ---------- init ---------- */
async function init(){
  renderAuthControls();
  await loadDate(new Date());
}
init();

/* ---------- helpers ---------- */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]) ); }

</script>
</body>
</html>